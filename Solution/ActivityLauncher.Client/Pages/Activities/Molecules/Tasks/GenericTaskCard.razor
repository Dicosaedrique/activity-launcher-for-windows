@inject ActivityController ActivityController
@inject IStringLocalizer<ActivityLocales> Localize

<MudCard Elevation="4">
    <MudCardHeader>
        <CardHeaderContent>
            <MudStack Row AlignItems="AlignItems.Center" Spacing="4">
                <TaskIcon TaskType="TaskType" Size="30" />
                <MudText Typo="Typo.body1" Style="font-weight: bold;">@DisplayName</MudText>
                <MudTooltip Text="@HelperTooltip">
                    <MudIconButton Class="pa-0" Icon="@Icons.Material.Filled.HelpOutline" />
                </MudTooltip>
            </MudStack>
        </CardHeaderContent>
        <CardHeaderActions>
            @if (EditMode)
            {
                <MudTooltip Text="@Localize["Activity.Dialog.Task.DeleteHelper"]">
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="OnRemove" />
                </MudTooltip>
            }
            else
            {
                <MudTooltip Text="@Localize["Activity.Dialog.Task.LaunchHelper"]">
                    <MudIconButton Icon="@Icons.Material.Filled.PlayArrow" Color="Color.Success" OnClick="LaunchTask" />
                </MudTooltip>
            }
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        @if (EditMode)
        {
            <MudTextField T="string" Value="Task.Name" ValueChanged="NameChanged" Label="@Localize["Activity.Dialog.Task.Name.Label"]" Required RequiredError="@Localize["Activity.Dialog.Task.Name.RequiredError"]" Variant="Variant.Filled" />
        }
        @TaskDetailTemplate
    </MudCardContent>
</MudCard>

@code {
    [Parameter]
    public ITask Task { get; set; } = null!;

    [Parameter]
    public bool EditMode { get; set; } = false;

    [Parameter]
    public TaskType TaskType { get; set; }

    [Parameter]
    public EventCallback OnNameChange { get; set; }

    [Parameter]
    public EventCallback OnRemove { get; set; }

    [Parameter]
    public RenderFragment TaskDetailTemplate { get; set; } = null!;

    private string DisplayName => string.IsNullOrWhiteSpace(Task.Name) ? Localize["Task.EmptyName"] : Task.Name;

    private string HelperTooltip => Localize[$"Activity.Dialog.Task.{TaskType}.HelperTooltip"];

    private async Task NameChanged(string name)
    {
        Task.Name = name;
        await OnNameChange.InvokeAsync();
    }

    private async Task LaunchTask()
    {
        await ActivityController.PromptLaunchTask(Task);
    }
}
